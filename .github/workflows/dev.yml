name: financial

on:
  push:
    branches: [ main_pre ]
  pull_request:
    branches: [ main_pre ]

jobs:
  build:

    runs-on: self-hosted

    steps:
    - uses: actions/checkout@v2
    - name: Set up JDK 11
      uses: actions/setup-java@v2
      with:
        java-version: '11'
        distribution: 'temurin'
        cache: maven
    - name: Build with Maven
      run: mvn -B package -DskipTests --file pom.xml
    - name: Login to ACR
      uses: aliyun/acr-login@v1
      with:
        login-server: https://registry.ap-northeast-1.aliyuncs.com
        username: "acr@1614211869785239"
        password: "7db9bf9b9b41e87164"
    - uses: satackey/action-docker-layer-caching@v0.0.11
      continue-on-error: true
    - name: Build and push image
      env:
        IMAGE_TAG: "dev"
      run: |
        docker build -t registry.ap-northeast-1.aliyuncs.com/fengkong/financial:dev -f Dockerfile-local .
        docker push registry.ap-northeast-1.aliyuncs.com/fengkong/financial:dev
        docker rmi registry.ap-northeast-1.aliyuncs.com/fengkong/financial:dev
    - name: redeploy
      run: curl https://cs.console.aliyun.com/hook/trigger?token=eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJjbHVzdGVySWQiOiJjNzg3MTNiYTcwYTVlNGRmNGE4ZWM3MjE1ZDRiYmJmZDciLCJpZCI6IjIwODYwNiJ9.tsbaKDApEB5-aDHCGrLPNR48o-BDor5KtCvdN3crSOqMuoG3pI0UwChgVjqUt2L7qT-m3MnimwEftSDz8qDT1G1YZhs2wyPkjJCNt7iytg3PzFnAXXjqVQGKUEzQzU90l8QwpxDY35MorHbc_Vm-94aqHdsXthVKS8s-1y62v2Y

